{
  "hash": "d7f15947ec0e67c4171bdfc097451cac",
  "result": {
    "markdown": "---\ntitle: \"Benchmarking the Speed of Cumulative Functions in TidyDensity\"\nauthor: \"Steven P. Sanderson II, MPH\"\ndate: \"2024-01-11\"\ncategories: [code, tidydensity, benchmark]\n---\n\n\n# Introduction\n\nStatistical analysis often involves calculating various measures on large datasets. Speed and efficiency are crucial, especially when dealing with real-time analytics or massive data volumes. The [TidyDensity](https://cran.r-project.org/web/packages/TidyDensity/index.html) package in R provides a set of fast cumulative functions for common statistical measures like mean, standard deviation, skewness, and kurtosis. But just how fast are these cumulative functions compared to doing the computations directly? In this post, I benchmark the cumulative functions against the base R implementations using the [rbenchmark](https://cran.r-project.org/web/packages/rbenchmark/index.html) package.\n\n# Setting the bench\n\nTo assess the performance of TidyDensity's cumulative functions, we'll employ the rbenchmark package for benchmarking and the ggplot2 package for visualization. I'll benchmark the following cumulative functions on random samples of increasing size:\n\n*   `cgmean()` - Cumulative geometric mean\n*   `chmean()` - Cumulative harmonic mean\n*   `ckurtosis()` - Cumulative kurtosis\n*   `cskewness()` - Cumulative skewness\n*   `cmean()` - Cumulative mean\n*   `csd()` - Cumulative standard deviation\n*   `cvar()` - Cumulative variance\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(TidyDensity)\nlibrary(rbenchmark)\nlibrary(dplyr)\nlibrary(ggplot2)\n\nset.seed(123)\n\nx1 <- sample(1e2) + 1e2\nx2 <- sample(1e3) + 1e3 \nx3 <- sample(1e4) + 1e4\nx4 <- sample(1e5) + 1e5\nx5 <- sample(1e6) + 1e6\n\ncg_bench <- benchmark(\n  \"100\" = cgmean(x1),\n  \"1000\" = cgmean(x2),\n  \"10000\" = cgmean(x3),\n  \"100000\" = cgmean(x4),\n  \"1000000\" = cgmean(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")\n)\n\n# Run benchmarks for other functions\nch_bench <- benchmark(\n  \"100\" = chmean(x1),\n  \"1000\" = chmean(x2),\n  \"10000\" = chmean(x3),\n  \"100000\" = chmean(x4),\n  \"1000000\" = chmean(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")\n)\n\nck_bench <- benchmark(\n  \"100\" = ckurtosis(x1),\n  \"1000\" = ckurtosis(x2),\n  \"10000\" = ckurtosis(x3),\n  \"100000\" = ckurtosis(x4),\n  \"1000000\" = ckurtosis(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")  \n)\n\ncs_bench <- benchmark(\n  \"100\" = cskewness(x1),\n  \"1000\" = cskewness(x2), \n  \"10000\" = cskewness(x3),\n  \"100000\" = cskewness(x4),\n  \"1000000\" = cskewness(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")\n)\n\ncm_bench <- benchmark(\n  \"100\" = cmean(x1),\n  \"1000\" = cmean(x2),\n  \"10000\" = cmean(x3),\n  \"100000\" = cmean(x4),\n  \"1000000\" = cmean(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")\n)\n\ncsd_bench <- benchmark(\n  \"100\" = csd(x1),\n  \"1000\" = csd(x2),\n  \"10000\" = csd(x3),\n  \"100000\" = csd(x4),\n  \"1000000\" = csd(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")  \n)\n\ncv_bench <- benchmark(\n  \"100\" = cvar(x1),\n  \"1000\" = cvar(x2),\n  \"10000\" = cvar(x3),\n  \"100000\" = cvar(x4), \n  \"1000000\" = cvar(x5),\n  replications = 100L,\n  columns = c(\"test\",\"replications\",\"elapsed\", \"relative\",\"user.self\",\"sys.self\")\n)\n\nbenchmarks <- rbind(cg_bench, ch_bench, ck_bench, cs_bench, cm_bench, csd_bench, cv_bench)\n\n# Arrange benchmarks and plot\nbench_tbl <- benchmarks |> \n  mutate(func = c(\n    rep(\"cgmean\", 5), \n    rep(\"chmean\", 5),\n    rep(\"ckurtosis\", 5),\n    rep(\"cskewness\", 5),\n    rep(\"cmean\", 5),\n    rep(\"csd\", 5),\n    rep(\"cvar\", 5)\n    )\n  ) |>\n  arrange(func, test) |>\n  select(func, test, everything())\n\nbench_tbl |>\n  ggplot(aes(x=test, y=elapsed, group = func, color = func)) +\n    geom_line() +\n    facet_wrap(~func, scales=\"free_y\") +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n    labs(title=\"Cumulative Function Speed Comparison\",\n       x=\"Sample Size\",\n       y=\"Elapsed Time (sec)\",\n       color = \"Function\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nThe results show that the TidyDensity cumulative functions scale extremely well as the sample size increases. The elapsed time remains very low even at 1 million observations. The base R implementations like `var()` and `sd()` perform significantly worse when used inside of an `sapply` at large sample sizes. What was not tested however is `cmedian()` and this is because the performance is very slow once we reach 1e4 compared to the other functions as such that it would take too long to run the benchmark if it ran at all.\n\nSo if you need fast statistical functions that can scale to big datasets, the TidyDensity cumulative functions are a great option! They provide massive speedups over base R while returning the same final result.\n\nLet me know in the comments if you have any other benchmark ideas for comparing R packages! I'm always looking for interesting performance comparisons to test out.",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}